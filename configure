#!/bin/sh

# This configure script written by Brian Callahan <bcallah@openbsd.org>
# and released into the Public Domain.

cccheck() {
  if [ ! -z "$CC" ] ; then
cat << EOF > conftest.c
int main(void){return 0;}
EOF
    "$CC" -o /dev/null conftest.c > /dev/null 2>&1
    if [ $? -eq 0 ] ; then
      rm -f conftest.c
      cc="$CC"
      cco="="
      return 1
    else
      rm -f conftest.c
      cco="?="
    fi
  else
    cco="?="
  fi

  for compiler in cc clang gcc ; do
    cat << EOF > conftest.c
	int
#if defined(__llvm__) && defined(__clang__)
	c=0
#elif defined(__GNUC__)
	c=0
#else
	c=1
#endif
      ;
      int main(void){return c;}
EOF

    "$compiler" -o conftest conftest.c > /dev/null 2>&1

    if [ $? -eq 0 ] ; then
      ./conftest
      c=$?
      rm -f conftest conftest.c

      if [ $c -eq 0 ] ; then
        cc="$compiler"
        return 1
      fi
    else
      rm -f conftest.c
    fi
  done
  return 0
}

arc4randomuniformcheck() {
  cat << EOF > conftest.c
#include <stdlib.h>
int main(void){arc4random_uniform(0);return 0;}
EOF
  "$cc" $tflags -o /dev/null conftest.c > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest.c
    return 1
  else
    rm -f conftest.c
    return 0
  fi
}

getprognamecheck() {
  cat << EOF > conftest.c
#include <stdlib.h>
int main(void){getprogname();return 0;}
EOF
  "$cc" $tflags -o /dev/null conftest.c > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest.c
    return 1
  else
    rm -f conftest.c
    return 0
  fi
}

libbsdcheck() {
  cat << EOF > conftest.c
#include <stdlib.h>
int main(void){strtonum(NULL, 0, 0, NULL);return 0;}
EOF
  tlibs="-L/usr/local/lib -L/usr/pkg/lib -L/opt/lib -lbsd"
  "$cc" $tflags -o /dev/null conftest.c $tlibs > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest.c
    return 1
  else
    rm -f conftest.c
    return 0
  fi
}

strtonumcheck() {
  cat << EOF > conftest.c
#include <stdlib.h>
int main(void){strtonum(NULL, 0, 0, NULL);return 0;}
EOF
  "$cc" $tflags -o /dev/null conftest.c > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest.c
    return 1
  else
    rm -f conftest.c
    return 0
  fi
}

prefix="/usr/local"
target=`uname -m`
cflags="-O2 -pipe"

printf "checking for C compiler... "
cccheck
if [ $? -eq 0 ] ; then
  echo "not found"
  echo "Please install a C compiler and re-run configure."
  exit 1
else
  echo "$cc"
fi

printf "checking for OS... "
os=`uname -s`
echo "$os"

if [ "x$os" = "xNetBSD" ] ; then
  tflags="-D_OPENBSD_SOURCE"
  cflags="$cflags $tflags"
fi

printf "checking for arc4random_uniform... "
arc4randomuniformcheck
if [ $? -eq 0 ] ; then
  pflags=" -DLIBBSD"
  libs=" -lbsd"
  echo "no"
else
  pflags=""
  libs=""
  echo "yes"
fi

printf "checking for getprogname... "
getprognamecheck
if [ $? -eq 0 ] ; then
  pflags=" -DLIBBSD"
  libs=" -lbsd"
  echo "no"
else
  echo "yes"
fi

printf "checking for strtonum... "
strtonumcheck
if [ $? -eq 0 ] ; then
  pflags=" -DLIBBSD"
  libs=" -lbsd"
  echo "no"
else
  echo "yes"
fi

if [ ! -z "$libs" ] ; then
  printf "checking for libbsd... "
  libbsdcheck
  if [ $? -eq 0 ] ; then
    echo "not found"
    echo "You need libbsd to build shuf!"
    exit 1
  fi
fi

cat << EOF > Makefile
# This Makefile automatically generated by configure.

CC $cco		$cc
CFLAGS ?=	-O2 -pipe
PREFIX ?=	/usr/local

all:
	\${CC} \${CFLAGS}$pflags \${LDFLAGS} -o shuf shuf.c$libs

install:
	install -c -S -s -m 755 shuf \${DESTDIR}\${PREFIX}/bin
	install -c -S -m 644 shuf.1 \${DESTDIR}\${PREFIX}/man/man1

clean:
	rm -f shuf shuf.core

distclean: clean
	rm -f Makefile
EOF
